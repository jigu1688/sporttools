# 学年数据存储、调取、查看系统完整分析

## 📊 现状总结
系统已具备**完整的学年数据管理功能**，包括创建、查询、更新、删除、升级等操作。

---

## 一、数据存储方式

### 1. 学年元数据存储
**表名**: `school_years`

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PRIMARY KEY | 主键 |
| school_id | INTEGER | FK(schools) | 所属学校 |
| year_name | STRING(50) | NOT NULL | 学年名称（如"2025-2026学年"） |
| start_date | DATE | NOT NULL | 学年起始日期 |
| end_date | DATE | NOT NULL | 学年结束日期 |
| academic_year | STRING(20) | UNIQUE, NOT NULL | 学年标识（如"2025-2026"） |
| status | ENUM | DEFAULT inactive | 状态：active/completed/inactive |
| created_at | DATETIME | DEFAULT now | 创建时间 |
| updated_at | DATETIME | ON UPDATE | 修改时间 |
| completed_at | DATETIME | NULL | 完成时间 |
| completed_by | STRING(50) | NULL | 完成人 |
| imported_at | DATETIME | NULL | 导入时间 |
| imported_by | STRING(50) | NULL | 导入人 |

### 2. 学年关联的业务数据

```
学年 (SchoolYear)
├── 班级数据 (Class)
│   ├── class_name: 班级名称
│   ├── grade: 年级（如"一年级"）
│   ├── academic_year: 学年标识字符串 ⚠️ 冗余字段
│   └── school_year_id: 学年ID (FK) ✓ 主要关联字段
│
├── 学生班级关系 (StudentClassRelation)
│   ├── academic_year: 学年标识字符串
│   ├── join_date: 加入班级日期
│   └── leave_date: 离开班级日期
│
├── 体测成绩 (PhysicalTest)
│   ├── academic_year: 学年标识字符串
│   ├── test_date: 测试日期
│   └── score: 成绩
│
└── 运动会 (SportsMeet)
    ├── school_year_id: 学年ID (FK) ✓
    ├── event_date: 运动会日期
    └── status: 运动会状态
```

---

## 二、数据调取方式（API接口）

### 后端API路由（/api/v1/school-years）

#### 1. 获取所有学年 ✓
```
GET /api/v1/school-years?school_id=1&status=active
```
**参数**:
- `school_id`: 可选，学校ID
- `status`: 可选，学年状态（active/completed/inactive）

**实现**: `school_year_crud.get_school_years(db, school_id, status)`

#### 2. 获取单个学年详情 ✓
```
GET /api/v1/school-years/{school_year_id}
```
**返回**: 学年完整信息

#### 3. 获取当前活跃学年 ✓
```
GET /api/v1/school-years/active
```
**逻辑**:
- 查询 status='active' 的学年
- 如果不存在，自动激活最新的学年（按 start_date DESC）

#### 4. 创建新学年 ✓
```
POST /api/v1/school-years
{
  "year_name": "2025-2026学年",
  "start_date": "2025-09-01",
  "end_date": "2026-08-31",
  "academic_year": "2025-2026",
  "status": "inactive"
}
```

#### 5. 更新学年 ✓
```
PUT /api/v1/school-years/{school_year_id}
```

#### 6. 设置当前学年 ✓
```
PUT /api/v1/school-years/{school_year_id}/set-active
```
**逻辑**: 将所有学年改为 inactive，指定学年改为 active

#### 7. 结束学年 ✓
```
PUT /api/v1/school-years/{school_year_id}/complete
```
**逻辑**: 设置 status='completed'，记录完成时间和完成人

#### 8. 学年升级（学年循环） ✓
```
POST /api/v1/school-years/{school_year_id}/promote
```
**升级逻辑**:
- 将当前学年标记为 completed
- 自动创建新学年（年份+1）
- 更新所有班级名称：一年级 → 二年级...六年级 → 七年级
- 九年级学生标记为 graduated
- 新学年设为 active

#### 9. 获取学年统计信息 ✓
```
GET /api/v1/school-years/{school_year_id}/statistics
```
**返回**: 班级数、学生数、体测数据等统计

#### 10. 删除学年
```
DELETE /api/v1/school-years/{school_year_id}
```
⚠️ 如果存在关联数据则会失败

---

## 三、前端数据查看方式

### 1. 学年管理页面 ✓
**路由**: `/school-year-management`
**文件**: `sport-web/src/pages/SchoolYearManagement.jsx`

**功能**:
- ✓ 表格显示所有学年（排序、筛选）
- ✓ 创建新学年
- ✓ 编辑学年信息
- ✓ 删除学年
- ✓ 激活学年（设为当前学年）
- ✓ 完成学年
- ✓ **升级学年**（自动晋级班级和学生）

**显示信息**:
```
学年名称 | 开始日期 | 结束日期 | 状态 | 操作
---------|---------|---------|------|-------
2025-2026学年 | 2025-09-01 | 2026-08-31 | active | 编辑 删除 升级
2024-2025学年 | 2024-09-01 | 2025-08-31 | completed | 编辑 删除
```

### 2. 学年统计信息展示 ✓
**显示内容**:
- 当前活跃学年名称
- 班级总数
- 学生总数
- 体测完成数
- 运动会数量

### 3. 学生历史记录按学年查询 ✓
**文件**: `sport-web/src/pages/StudentHistory.jsx`

**功能**:
- ✓ 按学年筛选学生记录
- ✓ 显示学生在各学年的班级、成绩等
- ✓ 支持跨学年查询

### 4. 学年在其他页面的应用

#### 班级管理
- 创建班级时选择学年
- 显示班级所属学年
- 升级学年时自动更新班级名称

#### 学生管理
- 学生加入班级时记录学年
- 学生离开班级时记录学年
- 显示学生当前班级的学年

#### 体测管理
- 新增体测成绩时指定学年
- 按学年查询体测数据
- 学年统计体测完成情况

#### 运动会管理
- 运动会关联学年
- 按学年筛选运动会

---

## 四、数据查询流程图

```
┌─────────────────────────────┐
│   前端用户操作              │
└──────────────┬──────────────┘
               │
               ▼
┌─────────────────────────────────┐
│  SchoolYearManagement.jsx       │
│  (Redux Action + Service)       │
└──────────────┬──────────────────┘
               │
               ▼
┌─────────────────────────────────┐
│  schoolYearService.js           │
│  (API调用)                      │
└──────────────┬──────────────────┘
               │
               ▼
┌─────────────────────────────────┐
│  GET /api/v1/school-years       │
│  (FastAPI 路由)                 │
└──────────────┬──────────────────┘
               │
               ▼
┌─────────────────────────────────┐
│  routes/school_year.py          │
│  (权限验证 + 参数验证)          │
└──────────────┬──────────────────┘
               │
               ▼
┌─────────────────────────────────┐
│  crud/school_year_crud.py       │
│  (数据库查询逻辑)               │
└──────────────┬──────────────────┘
               │
               ▼
┌─────────────────────────────────┐
│  SELECT FROM school_years       │
│  WHERE ... (SQLAlchemy ORM)     │
└──────────────┬──────────────────┘
               │
               ▼
┌─────────────────────────────────┐
│  SQLite3 数据库                 │
│  sports_teaching.db             │
└─────────────────────────────────┘
```

---

## 五、数据关联完整性检查

### ⚠️ 识别的问题

#### 问题1: 数据冗余
学年数据在两个地方存储：
1. **关系标准化存储**: `Class.school_year_id` (FK) ✓
2. **字符串冗余存储**: `Class.academic_year` (字符串) ❌

**影响**: 数据一致性难以保证，升级学年时需要同时更新两个字段

**示例**:
```python
# 当前升级逻辑需要更新：
class.grade_level = new_grade_level  # 年级数字
class.grade = new_grade_name        # 年级名称
# 但 class.academic_year 怎么办？ ❌ 代码中没有更新
```

#### 问题2: 学年状态切换的自动化
```python
# 当前逻辑（school_year_crud.py）
def get_active_school_year(db: Session, school_id: int = None):
    result = db.query(SchoolYear).filter(SchoolYear.status == active).first()
    if not result:
        # 自动激活最新学年 - 这可能不符合业务意图
        result = db.query(SchoolYear).order_by(SchoolYear.start_date.desc()).first()
        result.status = active  # 隐式修改数据库状态
        db.commit()
    return result
```

**问题**: 查询操作意外修改了数据库状态

#### 问题3: 关联数据的级联删除策略
```python
# models.py
school_years = relationship("SchoolYear", back_populates="school_years", 
                            cascade="all, delete-orphan")
```

**影响**: 删除学年会级联删除所有班级，然后级联删除所有学生！

---

## 六、现有功能完整度评估

| 功能 | 状态 | 说明 |
|------|------|------|
| 创建学年 | ✓ 完整 | 支持设置日期范围和状态 |
| 查询学年 | ✓ 完整 | 支持按学校/状态筛选 |
| 修改学年 | ✓ 完整 | 可修改名称、日期、状态 |
| 激活学年 | ✓ 完整 | 支持手动设置当前学年 |
| 完成学年 | ✓ 完整 | 支持标记为已完成并记录操作人 |
| 删除学年 | ✓ 有风险 | 会级联删除关联数据！ |
| 学年升级 | ✓ 完整 | 自动晋级班级、学生，创建新学年 |
| 统计信息 | ✓ 完整 | 显示班级数、学生数、体测数据 |
| 前端展示 | ✓ 完整 | 有专属管理页面 |
| 数据导入/导出 | ❌ 缺失 | 暂无学年数据的批量导入导出 |
| 多学年对比 | ⚠️ 部分 | 只能单学年查询，不支持同期对比 |

---

## 七、推荐改进方向

### 优先级 1（关键）
1. **修复数据冗余问题**
   - 移除 `academic_year` 字符串字段，统一使用学年ID关联
   - 更新所有查询逻辑

2. **修复级联删除风险**
   - 改为 `cascade="none"` 或实现软删除
   - 删除前检查是否有关联数据

3. **修复get_active_school_year的副作用**
   - 将自动激活逻辑分离到专门的函数
   - 查询不应修改数据库状态

### 优先级 2（功能增强）
1. **实现学年数据导入导出**
   - 支持CSV/Excel批量导入班级、学生、体测数据
   - 支持按学年导出数据

2. **支持多学年对比**
   - 可同时查看多个学年的体测成绩
   - 支持成绩趋势分析

3. **学年模板功能**
   - 保存班级、课程等学年配置为模板
   - 新学年可快速从模板创建

4. **学年归档功能**
   - 完成的学年支持只读归档
   - 支持压缩存储历年数据

---

## 八、使用场景

### 场景1: 学年初始化
```
1. 管理员在学年管理页面 → 创建新学年
2. 输入年份、日期范围
3. 系统自动生成 academic_year (如"2025-2026")
4. 创建班级时选择该学年
5. 导入学生分配到班级
6. 激活该学年为"当前学年"
```

### 场景2: 学年升级（最复杂的操作）
```
1. 学年结束时，管理员在学年管理页面 → 升级学年
2. 系统自动：
   - 完成当前学年（status='completed'）
   - 创建新学年（year+1）
   - 一年级 → 二年级，...，六年级 → 七年级
   - 九年级学生标记为 graduated
   - 新学年设为 active
3. 新学年的班级、学生数据已准备好
4. 教师可继续进行新学年的教学记录
```

### 场景3: 历史数据查询
```
1. 教师在学生历史页面
2. 按学年筛选（如"2023-2024学年"）
3. 查看该学年内学生的班级、成绩等全部记录
4. 支持导出为报告
```

---

## 总体结论

✅ **系统具备完整的学年管理功能**
- 数据存储完善
- API接口齐全
- 前端操作友好
- 学年升级逻辑完整

⚠️ **存在的关键问题**
- 数据冗余（academic_year 重复存储）
- 级联删除风险
- 查询函数有副作用

🎯 **可用性评估**
- 当前版本可满足日常使用
- 建议优先修复数据一致性问题
- 后续可增加导入导出、多学年对比等功能
