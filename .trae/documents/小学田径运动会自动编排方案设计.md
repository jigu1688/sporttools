# 小学田径运动会自动编排方案设计

## 一、需求分析

根据您描述的小学田径运动会需求，自动编排系统需要满足以下核心规则：

1. **年级分组**：各年级分开比赛，同年级班与班对抗
2. **性别分组**：每个项目男女生分开报名和比赛
3. **班级分组**：每个项目每组由各班一名选手组成
4. **组数计算**：根据各班报名人数确定组数（如每班3人，4个班，则分成3组，每组4人）

## 二、现有系统分析

现有系统已经实现了基本的运动会编排功能，包括：
- Redux状态管理（sportsMeets, events, schedules, registrations, referees, venues）
- 基础的自动编排逻辑（handleAutoSchedule函数）
- 多种视图展示（表格、日历、场馆视图）
- 赛程编辑、删除、分组管理等功能

## 三、自动编排方案设计

### 1. 数据结构扩展

**现有数据结构需要扩展以下字段：**

| 实体 | 现有字段 | 需要添加字段 |
|------|----------|--------------|
| events | id, name, type | grade(年级), maleQuota(男生名额), femaleQuota(女生名额) |
| registrations | id, eventId, sportsMeetId | grade(年级), className(班级), gender(性别), studentName(学生姓名) |
| schedules | id, eventId, sportsMeetId, date, startTime, endTime, venue, 裁判, groupCount, status | grade(年级), gender(性别), groupName(分组名称) |

### 2. 编排算法设计

**核心编排流程：**

1. **数据验证**：检查是否已添加运动会、项目、报名信息
2. **年级分组**：将项目按年级分组
3. **性别分组**：每个年级项目按性别分组
4. **班级统计**：统计每个年级、性别、项目的参赛班级数量
5. **组数计算**：根据各班报名人数确定组数（每组由各班一名选手组成）
6. **赛程生成**：为每个年级、性别、项目生成对应组数的赛程
7. **场馆分配**：根据项目类型和场馆容量分配合适场馆
8. **裁判分配**：根据裁判专业领域和可用性分配合适裁判
9. **时间安排**：按年级优先级和项目类型安排比赛时间
10. **冲突检测**：确保场馆和裁判在同一时间不冲突
11. **保存赛程**：将生成的赛程保存到Redux状态

### 3. 关键算法实现

**组数计算逻辑：**
```javascript
// 统计每个班级的报名人数
const classCounts = {};
registrations.forEach(reg => {
  const key = `${reg.className}-${reg.gender}`;
  classCounts[key] = (classCounts[key] || 0) + 1;
});
// 组数 = 各班报名人数的最大值
const groupCount = Math.max(...Object.values(classCounts));
```

**分组生成逻辑：**
```javascript
// 按年级、性别、班级分组
const groupedRegistrations = registrations.reduce((acc, reg) => {
  const key = `${reg.grade}-${reg.gender}-${reg.className}`;
  if (!acc[key]) {
    acc[key] = [];
  }
  acc[key].push(reg);
  return acc;
}, {});

// 生成每组的选手
for (let i = 0; i < groupCount; i++) {
  const groupAthletes = [];
  // 从每个班级中选取第i名选手
  Object.keys(groupedRegistrations).forEach(key => {
    const athletes = groupedRegistrations[key];
    if (athletes[i]) {
      groupAthletes.push(athletes[i]);
    }
  });
  // 生成赛程
  const schedule = {
    id: Date.now().toString(),
    sportsMeetId,
    eventId,
    eventName,
    grade,
    gender,
    groupName: `第${i+1}组`,
    groupAthletes,
    // 其他字段...
  };
  schedules.push(schedule);
}
```

### 4. 时间安排策略

1. **按年级优先级**：低年级优先安排，高年级随后
2. **按项目类型**：田赛和径赛交替安排
3. **场馆利用率**：最大化场馆利用率，减少场馆空闲时间
4. **裁判利用率**：合理安排裁判时间，避免过度劳累

### 5. 与现有系统集成

1. **扩展现有组件**：
   - SportsMeetManagement：添加年级和性别字段
   - EventManagementPage：添加年级和名额设置
   - RegistrationManagementPage：添加年级、班级、性别字段

2. **重写自动编排函数**：
   - 替换现有handleAutoSchedule函数
   - 实现新的编排算法
   - 添加冲突检测和解决机制

3. **优化视图展示**：
   - 在表格视图中添加年级和性别筛选
   - 在分组管理中支持按班级和性别分组
   - 添加年级和性别统计功能

## 四、实施步骤

1. **数据结构扩展**：修改Redux状态和相关组件
2. **编排算法实现**：重写handleAutoSchedule函数
3. **冲突检测实现**：添加场馆和裁判冲突检测
4. **UI组件优化**：更新相关页面组件，支持年级和性别筛选
5. **测试和验证**：测试不同场景下的编排效果

## 五、预期效果

1. **符合学校需求**：自动生成符合小学田径运动会规则的赛程
2. **可视化展示**：支持多种视图展示，方便查看和调整
3. **冲突检测**：自动检测并避免场馆和裁判冲突
4. **易于调整**：生成的赛程可以手动调整
5. **统计功能**：支持按年级、性别、项目统计

## 六、技术实现

- **前端框架**：React 18
- **状态管理**：Redux Toolkit
- **UI组件库**：Ant Design 6.x
- **算法实现**：JavaScript
- **冲突检测**：基于时间、场馆、裁判的三维冲突检测

这个方案结合了您描述的小学田径运动会需求和现有系统设计，能够实现符合实际需求的自动编排功能。